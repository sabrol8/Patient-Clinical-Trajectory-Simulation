# Patient Clinical Trajectory Simulation
This project demonstrates a hybrid ICU simulation model integrating AnyLogic with Python to build a proof-of-concept digital twin for predicting patient trajectories. Using agent-based simulation, AnyLogic replicates ICU workflows where each patient has 12 dynamic vitals and 3 static features. These 15 variables are sent in real time to a Python neural network, classifying patients into: Fast Recovery, Slow Recovery, Fast Decline, or Delayed Decline.Pypeline and pycommunicator enable seamless bidirectional communication between AnyLogic and Python. The neural network, stored in HDF5 format, is loaded in Python and invoked during simulation for live predictions in AnyLogic. This integration exemplifies how digital twin technology supports real-time monitoring, forecasting, and decision-making in ICU settings.
## Hierarchal Data File and Nature of Neural Network
This neural network model is designed to predict the clinical trajectory cluster of ICU patients and serves as the core predictive engine within the digital twin framework. It accepts two types of inputs: dynamic and static vitals. The dynamic input has a shape of [null,96,12] and 12 corresponds to the number of dynamic vital signs per time step. The "null" dimension denotes the batch size, which is flexible but is set to 1 in the ICU simulation, representing the most recent 24-hour record of a patient. For time windows shorter than 24 hours, the network supports masking by using -1 for missing values across any vital. The static input has a shape of [null,3] with 3 being the number of patient-specific static features and again null representing the batch size (assumed to be 1). The output of the network is an array of logits representing the likelihood of the patient belonging to each of the four predefined clinical trajectory clusters: Fast Recovery, Slow Recovery, Fast Decline, and Delayed Decline.
## Anylogic Model and Python Code
Cluster prediction for patient trajectories in AnyLogic is implemented via two versions: simulated data and external data file. In the simulated version, vital signs are generated using custom statistical distributions, while the external version imports data from an Excel file. Despite differing data sources, both follow the same pipeline to interface with the Python-based neural network.Built with TensorFlow and Keras, the neural network is managed by a dedicated Python class that handles input processing and prediction. Dynamic and static vitals are passed as NumPy arrays to the model, which outputs logits for four clusters. A softmax function converts these to probabilities, and the class with the highest probability is selected.The index-to-cluster mapping is: 0 – Fast Decline, 1 – Fast Recovery, 2 – Slow Recovery, and 3 – Delayed Decline. For instance, an output of 2 maps the patient to the Slow Recovery cluster.
### Simulated Data Version:Input Data Creation Approach
In the simulated data version of the AnyLogic model, dynamic vitals are generated hourly using custom probability distributions and stored in a string array acting as a temporary database. Since the neural network requires 96 input time steps (15-minute intervals over 24 hours), each hourly data point is replicated four times to match this resolution. This continues until 96 time steps are filled.If the simulation runs for less than 24 hours, missing intervals are filled with a masked value of -1.0, with four masked entries per missing hour. For example, after 16 hours, the first 32 entries are masked, and the remaining 64 contain actual data. If the simulation exceeds 24 hours, only the most recent 96 entries are retained to maintain a rolling window.Static vitals which consist of three constant patient-specific inputs—are added separately and remain unchanged. This methodology can be adapted depending on the resolution of available data.
### External Data File Version:Input Data Creation Approach
In the external data file version of the AnyLogic model, dynamic vitals are sourced from an external Excel file, thereby aligning with the concept of a digital twin where real or pre-collected patient data is continuously integrated into the simulation. The Excel file is structured such that each row represents a single data point collected every 15 minutes. Within the AnyLogic environment, a new row from the file is read and appended to a string array every 15 minutes, simulating a live data feed and acting as a database of time-stamped vital signs. Since the data is already in the required 15-minute resolution, no replication of entries is necessary—each 15-minute interval is represented by a unique, corresponding row from the Excel file. For simulations involving less than 24 hours of data (i.e., fewer than 96 data points), the missing time steps are filled with masked values of -1.0 to preserve the input structure expected by the neural network. For instance, if only 16 hours of data are available, the first 32 entries in the input array will be masked, and the remaining 64 will consist of actual Excel data entries. When the simulation surpasses 24 hours, additional rows are read from the Excel file to ensure that the input always reflects the most recent 96 data points, thus maintaining a rolling 24-hour window. The static vitals are handled separately by a dedicated function that appends three static data points to a static input array, which remains fixed throughout the simulation run. This version underscores the flexibility of the model to incorporate external datasets in real-time or batch mode, facilitating the broader vision of patient-specific digital twins in ICU simulation environments.
### Integration and Implementation
The integration and implementation process is consistent across both the simulated data and external data file versions of the AnyLogic model. Once the dynamic and static data arrays are constructed within AnyLogic, the pycommunicator module is used to seamlessly load and interface with the Python code, enabling bidirectional communication between AnyLogic and the neural network hosted in Python. Cluster prediction is triggered at regular intervals—specifically, every 12 hours—using a time-based event mechanism in AnyLogic. During each event trigger, the predict function from the Python code is invoked, with dynamic and static data passed as string-formatted function parameters. These inputs are parsed and converted into NumPy arrays in Python, which are then fed into the trained neural network model. The network computes the logits and applies the softmax function to generate cluster probabilities, from which the maximum probability index is identified and returned to AnyLogic as the predicted patient trajectory cluster via pycommunicator. The 12-hour prediction interval aligns with standard ICU shift durations, ensuring that cluster predictions are updated at the start of each new shift based on the most recent 24-hour vital data. Nevertheless, this frequency is fully customizable and can be adjusted, for instance, to hourly predictions depending on the user’s clinical or experimental requirements. Additionally, while the current implementation feeds the 24-hour data as a single batch for simplicity, the architecture supports batching of multiple data records to accommodate alternative prediction strategies or larger-scale simulations.
